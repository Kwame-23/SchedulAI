<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Sessions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons (Optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* Reset & Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      color: #1E1E1E;
      background: #f7f9fc;
      margin: 0;
    }
    
    /* DASHBOARD LAYOUT */
    .dashboard-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background-color: #1E1E1E;
      color: #fff;
      display: flex;
      flex-direction: column;
    }
    .logo-container {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .logo-container img {
      max-width: 100%;
      height: auto;
    }
    .menu {
      flex: 1;
      overflow-y: auto;
    }
    .menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .menu li {
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .menu a {
      display: block;
      padding: 15px 20px;
      color: #fff;
      text-decoration: none;
      transition: background 0.3s;
    }
    .menu a:hover {
      background-color: #00bf63;
    }
    .logout-container {
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .logout-container a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
    }
    .logout-container a:hover {
      color: #00bf63;
    }
    
    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #fff;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid #eee;
    }
    .top-bar input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      width: 200px;
    }
    
    .content {
      padding: 20px;
      overflow-y: auto;
      background: #fff;
    }
    .page-header {
      background-color: #ffff; /* accent color */
      color: #1E1E1E;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .page-header h1 {
      margin: 0;
      font-weight: 300;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="logo-container">
        <img src="{{ url_for('static', filename='schedulai.svg') }}" alt="SchedulAI Logo">
      </div>
      <nav class="menu">
        <ul>
          <li><a href="{{ url_for('lecturers') }}">Lecturers</a></li>
          <li><a href="{{ url_for('courses') }}">Courses</a></li>
          <li><a href="{{ url_for('student_courses') }}">Student Course Selection</a></li>
          <li><a href="{{ url_for('rooms') }}">Rooms</a></li>
          <li><a href="{{ url_for('assign_sessions') }}" style="background-color: #00bf63;">Assign Sessions</a></li>
          <li><a href="{{ url_for('run_scheduler_route') }}">Generate Timetable</a></li>
        </ul>
      </nav>
      <div class="logout-container">
        <a href="{{ url_for('dashboard') }}">Back</a>
      </div>
    </aside>
    
    <!-- MAIN CONTENT with Tabs -->
    <main class="main-content">
      <header class="top-bar">
        <input type="text" placeholder="Search" />
      </header>
      
      <div class="content">
        <div class="page-header">
          <h1>Assign Sessions to Courses</h1>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-info">
              {% for msg in messages %}
                <p class="m-0">{{ msg }}</p>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="sessionTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="assign-tab" data-bs-toggle="tab" data-bs-target="#assign" type="button" role="tab" aria-controls="assign" aria-selected="true">
              Assign Sessions
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="view-all-tab" data-bs-toggle="tab" data-bs-target="#view-all" type="button" role="tab" aria-controls="view-all" aria-selected="false">
              View All Sessions
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="edit-sessions-tab" data-bs-toggle="tab" data-bs-target="#edit-sessions" type="button" role="tab" aria-controls="edit-sessions" aria-selected="false">
              Edit Sessions
            </button>
          </li>
        </ul>
        
        <!-- Tabs Content -->
        <div class="tab-content" id="sessionTabsContent">
          <!-- Tab 1: Session Assignment (Existing Functionality) -->
          <div class="tab-pane fade show active" id="assign" role="tabpanel" aria-labelledby="assign-tab">
            <div class="row g-3" id="coursesContainer">
              {% for course in courses %}
                {% set courseID = course[0] %}
                {% set courseCode = course[1] %}
                {% set courseName = course[2] %}
                {% set credits = course[3] %}
                <div class="col-sm-6 col-md-4 col-lg-3 d-flex">
                  <div class="card flex-fill course-card">
                    <div class="card-body d-flex flex-column">
                      <h5 class="card-title">{{ courseCode }} - {{ courseName }}</h5>
                      <p class="card-text mb-4">Credits: {{ credits }}</p>
                      <button type="button" class="btn btn-primary mt-auto align-self-start" data-bs-toggle="modal" data-bs-target="#modalCourse{{ courseID }}" onclick="sessionCounters['{{ courseCode }}'] = 0; clearTable('{{ courseCode }}');">
                        Assign Sessions
                      </button>
                    </div>
                  </div>
                </div>
                <!-- Modal for each course -->
                <div class="modal fade" id="modalCourse{{ courseID }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Assign Sessions: {{ courseCode }} - {{ courseName }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form method="POST">
                          <input type="hidden" name="current_course_id" value="{{ courseID }}">
                          
                          <div class="mb-3">
                            <label for="cohortCount_{{ courseCode }}" class="form-label">Number of Cohorts:</label>
                            <input type="number" class="form-control" id="cohortCount_{{ courseCode }}" min="1" value="1" required>
                          </div>
                          
                          <div class="mb-3">
                            <button type="button" class="btn btn-secondary" onclick="generateSessions('{{ courseCode }}', '{{ credits }}')">Generate Default Sessions</button>
                            <button type="button" class="btn btn-outline-warning" onclick="clearTable('{{ courseCode }}')">Clear Rows</button>
                          </div>
                          
                          <input type="hidden" id="session_count_{{ courseCode }}" name="session_count" value="0">
                          
                          <table class="table table-bordered">
                            <thead>
                              <tr>
                                <th>Cohort</th>
                                <th>Main Lecturer</th>
                                <th>Faculty Intern</th>
                                <th>Session Type</th>
                                <th>Duration</th>
                                <th>Enrollments</th>
                              </tr>
                            </thead>
                            <tbody id="tbody_{{ courseCode }}">
                              <!-- Dynamic rows will be added here -->
                            </tbody>
                          </table>
                          
                          <button type="button" class="btn btn-info mb-2" onclick="addSessionRow('{{ courseCode }}')">Add Another Session</button>
                          <br>
                          <button type="submit" class="btn btn-success" onclick="this.disabled = true; this.form.submit();">Save Assignments</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          
          <!-- Tab 2: View All Sessions -->
          <div class="tab-pane fade" id="view-all" role="tabpanel" aria-labelledby="view-all-tab">
            <div class="mb-3">
              <input type="text" id="allSessionsSearch" placeholder="Search sessions..." class="form-control">
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-bordered" id="allSessionsTable">
                <thead>
                  <tr>
                    <th>SessionID</th>
                    <th>Course Code</th>
                    <th>Lecturer Name</th>
                    <th>Cohort Name</th>
                    <th>Session Type</th>
                    <th>Duration</th>
                    <th>Enrollments</th>
                  </tr>
                </thead>
                <tbody>
                  {% for session in all_sessions %}
                  <tr>
                    <td>{{ session.SessionID }}</td>
                    <td>{{ session.CourseCode }}</td>
                    <td>{{ session.LecturerName }}</td>
                    <td>{{ session.CohortName }}</td>
                    <td>{{ session.SessionType }}</td>
                    <td>{{ session.Duration }}</td>
                    <td>{{ session.NumberOfEnrollments }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              <!-- Optional: Add pagination controls here if needed -->
            </div>
          </div>

          <div class="tab-pane fade" id="edit-sessions" role="tabpanel" aria-labelledby="edit-sessions-tab">
            <div class="page-header">
              <h1>Edit Sessions</h1>
            </div>
            <!-- Form for editing sessions -->
            <form method="POST" action="{{ url_for('edit_session_assignments') }}">
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>SessionID</th>
                      <th>Course Code</th>
                      <th>Lecturer Name</th>
                      <th>Cohort Name</th>
                      <th>Session Type</th>
                      <th>Duration</th>
                      <th>Enrollments</th>
                      <th>Delete</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for session in all_sessions %}
                    <tr>
                      <!-- Display SessionID and pass it as a hidden field -->
                      <td>
                        {{ session.SessionID }}
                        <input type="hidden" name="session_id_{{ session.SessionID }}" value="{{ session.SessionID }}">
                      </td>
                      <!-- Editable Course Code -->
                      <td>
                        <input type="text" name="course_code_{{ session.SessionID }}" class="form-control" value="{{ session.CourseCode }}" required>
                      </td>
                      <!-- Editable Lecturer Name -->
                      <td>
                        <input type="text" name="lecturer_name_{{ session.SessionID }}" class="form-control" value="{{ session.LecturerName }}" required>
                      </td>
                      <!-- Editable Cohort Name -->
                      <td>
                        <input type="text" name="cohort_name_{{ session.SessionID }}" class="form-control" value="{{ session.CohortName }}" required>
                      </td>
                      <!-- Editable Session Type: uses a select populated from session_types -->
                      <td>
                        <select name="session_type_{{ session.SessionID }}" class="form-select" required>
                          {% for st in session_types %}
                            <option value="{{ st }}" {% if st == session.SessionType %}selected{% endif %}>{{ st }}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <!-- Editable Duration: uses a select populated from durations -->
                      <td>
                        <select name="duration_{{ session.SessionID }}" class="form-select" required>
                          {% for d in durations %}
                            <option value="{{ d }}" {% if d == session.Duration %}selected{% endif %}>{{ d }}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <!-- Editable Number of Enrollments -->
                      <td>
                        <input type="number" name="enrollments_{{ session.SessionID }}" class="form-control" min="0" value="{{ session.NumberOfEnrollments }}" required>
                      </td>
                      <!-- Delete checkbox for this session -->
                      <td class="text-center">
                        <input type="checkbox" name="delete_{{ session.SessionID }}" value="1">
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <button type="submit" class="btn btn-success">Save Changes</button>
            </form>
          </div>
        </div>
      </div>
      </div>
    </main>
  </div>
  
  <!-- Bootstrap Icons (Optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js" defer></script>
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Data from Flask, JSON-encoded
    const coursesData      = JSON.parse('{{ courses|tojson|safe }}');
    const lecturersData    = JSON.parse('{{ lecturers|tojson|safe }}');
    const sessionTypesData = JSON.parse('{{ session_types|tojson|safe }}');
    const durationsData    = JSON.parse('{{ durations|tojson|safe }}');
    
    // Object to track the number of session rows per course
    let sessionCounters = {};
    
    /* ========== Search Filter Logic for Course Cards ========== */
    function filterCourses() {
      const searchValue = document.getElementById('searchInput').value.toLowerCase();
      const courseColumns = document.querySelectorAll('#coursesContainer > div.col-sm-6');
      courseColumns.forEach(col => {
        const titleElem = col.querySelector('.card-title');
        if (!titleElem) return;
        const titleText = titleElem.innerText.toLowerCase();
        col.style.display = titleText.includes(searchValue) ? 'block' : 'none';
      });
    }
    
    /* ========== Clear Table Rows for a Given Course ========== */
    function clearTable(courseCode) {
      const tbody = document.getElementById('tbody_' + courseCode);
      if (tbody) {
        tbody.innerHTML = '';
        sessionCounters[courseCode] = 0;
        const sessionCountInput = document.getElementById('session_count_' + courseCode);
        if (sessionCountInput) {
          sessionCountInput.value = 0;
        }
      }
    }
    
    /* ========== Generate Default Sessions ========== */
    function generateSessions(courseCode, credits) {
      credits = parseFloat(credits) || 0;
      const cohortCountInput = document.getElementById('cohortCount_' + courseCode);
      if (!cohortCountInput) return;
      const cohortCount = parseInt(cohortCountInput.value, 10) || 0;
      if (cohortCount < 1) {
        alert("Please specify at least 1 cohort.");
        return;
      }
      clearTable(courseCode);
      
      for (let i = 0; i < cohortCount; i++) {
        const letter = String.fromCharCode(65 + i); // A, B, C, etc.
        const cohortName = 'Section ' + letter;
        // Example default rule based on credits:
        if (credits === 1.0) {
          addDefaultRow(courseCode, cohortName, 'Lecture', '01:30:00');
          addDefaultRow(courseCode, cohortName, 'Lecture', '01:30:00');
          addDefaultRow(courseCode, cohortName, 'Discussion', '01:00:00');
        } else if (credits === 0.5) {
          addDefaultRow(courseCode, cohortName, 'Lecture', '01:30:00');
          addDefaultRow(courseCode, cohortName, 'Discussion', '01:00:00');
        } else if (credits === 0) {
          addDefaultRow(courseCode, cohortName, 'Discussion', '01:00:00');
        }
      }
    }
    
    /* ========== Add a Default Row ========== */
    function addDefaultRow(courseCode, cohortName, sessionTypeName, defaultDuration) {
      const tbody = document.getElementById('tbody_' + courseCode);
      if (!tbody) return;
      
      let sc = sessionCounters[courseCode] || 0;
      const row = tbody.insertRow();
      
      // Cohort cell
      let cell = row.insertCell();
      cell.innerHTML = `<input type="text" name="cohort_name_${sc}" value="${cohortName}" readonly class="form-control" required>`;
      
      // Main Lecturer cell
      cell = row.insertCell();
      cell.innerHTML = buildLecturerSelect(`lecturer_main_name_${sc}`, "Main Lecturer");
      
      // Faculty Intern cell
      cell = row.insertCell();
      cell.innerHTML = buildLecturerSelect(`lecturer_intern_name_${sc}`, "Faculty Intern");
      
      // Session Type cell
      cell = row.insertCell();
      let stHTML = `<select name="session_type_${sc}" class="form-select" required>`;
      sessionTypesData.forEach(st => {
        const sel = (st.toLowerCase() === sessionTypeName.toLowerCase()) ? 'selected' : '';
        stHTML += `<option value="${st}" ${sel}>${st}</option>`;
      });
      stHTML += `</select>`;
      cell.innerHTML = stHTML;
      
      // Duration cell
      cell = row.insertCell();
      let durHTML = `<select name="duration_${sc}" class="form-select" required>`;
      durationsData.forEach(d => {
        const sel = (d === defaultDuration) ? 'selected' : '';
        durHTML += `<option value="${d}" ${sel}>${d}</option>`;
      });
      durHTML += `</select>`;
      cell.innerHTML = durHTML;
      
      // Enrollments cell
      cell = row.insertCell();
      cell.innerHTML = `<input type="number" name="enrollments_${sc}" class="form-control" min="0" required>`;
      
      sc++;
      sessionCounters[courseCode] = sc;
      const sessionCountInput = document.getElementById('session_count_' + courseCode);
      if (sessionCountInput) {
        sessionCountInput.value = sc;
      }
    }
    
    /* ========== Add a Blank Session Row ========== */
    function addSessionRow(courseCode) {
      const tbody = document.getElementById('tbody_' + courseCode);
      if (!tbody) return;
      
      let sc = sessionCounters[courseCode] || 0;
      const row = tbody.insertRow();
      
      // Cohort cell
      let cell = row.insertCell();
      cell.innerHTML = `<input type="text" name="cohort_name_${sc}" class="form-control" placeholder="Section A" required>`;
      
      // Main Lecturer cell
      cell = row.insertCell();
      cell.innerHTML = buildLecturerSelect(`lecturer_main_name_${sc}`, "Main Lecturer");
      
      // Faculty Intern cell
      cell = row.insertCell();
      cell.innerHTML = buildLecturerSelect(`lecturer_intern_name_${sc}`, "Faculty Intern");
      
      // Session Type cell
      cell = row.insertCell();
      let stHTML = `<select name="session_type_${sc}" class="form-select" required>
                      <option value="">--Select--</option>`;
      sessionTypesData.forEach(st => {
        stHTML += `<option value="${st}">${st}</option>`;
      });
      stHTML += `</select>`;
      cell.innerHTML = stHTML;
      
      // Duration cell
      cell = row.insertCell();
      let durHTML = `<select name="duration_${sc}" class="form-select" required>
                      <option value="">--Select--</option>`;
      durationsData.forEach(d => {
        durHTML += `<option value="${d}">${d}</option>`;
      });
      durHTML += `</select>`;
      cell.innerHTML = durHTML;
      
      // Enrollments cell
      cell = row.insertCell();
      cell.innerHTML = `<input type="number" name="enrollments_${sc}" class="form-control" min="0" required>`;
      
      sc++;
      sessionCounters[courseCode] = sc;
      const sessionCountInput = document.getElementById('session_count_' + courseCode);
      if (sessionCountInput) {
        sessionCountInput.value = sc;
      }
    }
    
    /* ========== Build Lecturer <select> ========== */
    function buildLecturerSelect(fieldName, placeholder) {
      let html = `<select name="${fieldName}" class="form-select" required>
                    <option value="">-- ${placeholder} --</option>`;
      lecturersData.forEach(l => {
        const [lecturerName] = l;
        html += `<option value="${lecturerName}">${lecturerName}</option>`;
      });
      html += `</select>`;
      return html;
    }
    
    /* ========== Filter for "View All Sessions" Table ========== */
    document.getElementById('allSessionsSearch').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#allSessionsTable tbody tr');
      rows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
      });
    });
  </script>
</body>
</html>